<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Pacman</title>
        <style>
            * {
                padding: 0;
                margin: 0;
            }

            body {
                background-color: #2f2f2f;
            }

            canvas {
                background: black;
            }
        </style>
    </head>

    <body>
        <div style="height: 100vh; display: flex; align-items: center; justify-content: center">
            <canvas id="myCanvas" width="1200" height="450"></canvas>
        </div>

        <script>
            const canvas = document.getElementById("myCanvas")
            const ctx = canvas.getContext("2d")
            const tickInterval = 19
            const cellSize = 30
            const mouthNbTicks = 5

            let mouthOpen = false
            let isMoving = false
            let pacmanSize = cellSize / 2 - 2
            let pacmanDirection = "right"
            let pacmanSpeed = cellSize / 10
            let pacmanX = 400
            let pacmanY = 200

            const X = true
            const _ = false
            const board = [
                [X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X],
                [X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, _, X, X, X, X, X, _, _, X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, _, _, _, _, _, _, _, _, X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, _, _, _, _, _, _, _, _, X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, _, X, X, X, X, _, _, _, X, X, _, _, _, _, _, _, _, _, X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, _, X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, _, X, _, X, X, _, _, _, X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, _, X, _, _, X, _, _, _, X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, _, X, X, X, X, _, _, X, X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, _, _, _, _, _, _, _, _, X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, _, _, _, _, _, _, _, _, X, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _, X],
                [X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X, X],
            ]

            let mouthCounter = 0

            function tick() {
                draw()

                if (isMoving) {
                    movePacman(pacmanDirection)
                    if (collisionDetection()) {
                        isMoving = false
                        movePacman(pacmanDirection, true)
                    }
                }

                if (isMoving) {
                    mouthCounter++
                    if (mouthCounter === mouthNbTicks) {
                        mouthOpen = !mouthOpen
                        mouthCounter = 0
                    }
                } else {
                    mouthCounter = 0
                    mouthOpen = false
                }
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height)

                drawBoard()
                drawPacman(pacmanX, pacmanY, pacmanDirection, mouthOpen, pacmanSize)
            }

            function drawBoard() {
                let x = 0
                let y = 0

                for (const row of board) {
                    for (const cell of row) {
                        if (cell) {
                            ctx.beginPath()
                            ctx.rect(x, y, cellSize, cellSize)
                            ctx.fillStyle = "#7f96fa"
                            ctx.fill()
                            ctx.closePath()
                        }
                        x += cellSize
                    }
                    y += cellSize
                    x = 0
                }
            }

            function drawPacman(x, y, direction, mouth, size) {
                const rotateAngle = {
                    right: 0,
                    left: Math.PI,
                    up: -Math.PI / 2,
                    down: Math.PI / 2,
                }[direction]

                // Body
                ctx.beginPath()
                ctx.fillStyle = "rgb(255,221,0)"
                const startAngle = (mouth ? 0.25 : 0.1) * Math.PI + rotateAngle
                ctx.arc(x, y, size, startAngle, startAngle + Math.PI, false)
                ctx.fill()
                ctx.beginPath()
                const startAngle2 = (mouth ? 0.75 : 0.9) * Math.PI + rotateAngle
                ctx.arc(x, y, size, startAngle2, startAngle2 + Math.PI, false)
                ctx.fill()

                // Eye
                ctx.beginPath()
                if (direction === "right" || direction === "left") {
                    ctx.arc(x, y - size / 2, size / 5, 0, 2 * Math.PI, false)
                } else {
                    ctx.arc(x - size / 2, y, size / 5, 0, 2 * Math.PI, false)
                }
                ctx.fillStyle = "black"
                ctx.fill()
            }

            function movePacman(direction, reverse = false) {
                const pacmanCellMiddle = {
                    x: Math.floor(pacmanX / cellSize) * cellSize + cellSize / 2,
                    y: Math.floor(pacmanY / cellSize) * cellSize + cellSize / 2,
                }

                switch (direction) {
                    case "right":
                        pacmanX = reverse ? pacmanCellMiddle.x : pacmanX + pacmanSpeed
                        break
                    case "left":
                        pacmanX = reverse ? pacmanCellMiddle.x : pacmanX - pacmanSpeed
                        break
                    case "up":
                        pacmanY = reverse ? pacmanCellMiddle.y : pacmanY - pacmanSpeed
                        break
                    case "down":
                        pacmanY = reverse ? pacmanCellMiddle.y : pacmanY + pacmanSpeed
                        break
                }
            }

            function collisionDetection() {
                // testCell is at the bottom right of the 4 cells that need to be checked.
                const testCell = {
                    col: Math.round(pacmanX / cellSize),
                    row: Math.round(pacmanY / cellSize),
                }

                const isCenteredX = pacmanX % cellSize === cellSize / 2
                const isCenteredY = pacmanY % cellSize === cellSize / 2

                return (
                    (isCenteredX || isCenteredY ? false : board[testCell.row][testCell.col]) ||
                    (isCenteredX ? false : board[testCell.row - 1][testCell.col]) ||
                    (isCenteredY ? false : board[testCell.row][testCell.col - 1]) ||
                    board[testCell.row - 1][testCell.col - 1]
                )
            }

            function keyDownHandler(event) {
                if (event.code === "ArrowRight") {
                    pacmanDirection = "right"
                    isMoving = true
                } else if (event.code === "ArrowLeft") {
                    pacmanDirection = "left"
                    isMoving = true
                } else if (event.code === "ArrowUp") {
                    pacmanDirection = "up"
                    isMoving = true
                } else if (event.code === "ArrowDown") {
                    pacmanDirection = "down"
                    isMoving = true
                }
            }

            document.addEventListener("keydown", keyDownHandler, false)
            setInterval(tick, tickInterval)
        </script>
    </body>
</html>
